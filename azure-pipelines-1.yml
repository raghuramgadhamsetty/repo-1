# Pipeline: Create a branch in all 10 GitHub repos (repo-1 through repo-10)
# Run this pipeline and provide the branch name when prompted.

name: RollbackPipeline-$(Build.BuildId)-$(Date:yyyyMMddHHmmss)
appendCommitMessageToRunName: false

trigger: none

parameters:
  - name: PrevReleaseBranch
    displayName: 'Branch name for artifacts to be pickedup'
    type: string
  - name: Components
    displayName: 'select Components need to deployed'
    type: stringList
    values:
      - ApplicationComponent1
      - ApplicationComponent2
      - ApplicationComponent3
      - ApplicationComponent4
      - ApplicationComponent5
      - ApplicationComponent6
      - ApplicationComponent7
      - ApplicationComponent8
      - ApplicationComponent9
      - ApplicationComponent10
  - name: githubOwner
    displayName: 'GitHub owner/username'
    type: string
    default: 'raghuramgadhamsetty'

variables:
  - name: repoList
    value: 'repo-1,repo-2,repo-3,repo-4,repo-5,repo-6,repo-7,repo-8,repo-9,repo-10'

stages:
  - stage: Validate
    displayName: 'Validate inputs'
    jobs:
      - job: ValidateInputs
        displayName: 'Check parameters'
        pool:
          name: 'Default'
        steps:
          - script: |
              echo "Branch name: ${{ parameters.PrevReleaseBranch }}"
              echo "GitHub owner: ${{ parameters.githubOwner }}"
            displayName: 'Show parameters'

  # Stage 3: Requires approval before generating artifact.
  # Create environment 'ci-build-approval' in DevOps (Pipelines > Environments) and add Approvals.
  - stage: GatherCIBuildInfo
    displayName: 'Gather CI build info from all prev release branch'
    jobs:
      - deployment: GatherBuildInfo
        displayName: 'Latest CI run and artifact version per repo'
        environment: 'ci-build-approval'
        pool:
          name: 'Default'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: PowerShell@2
                  displayName: 'Trigger deploy for repos with artifacts (Prod West)'
                  env:
                    GITHUB_TOKEN: $(GITHUB_TOKEN)
                  inputs:
                    targetType: 'inline'
                    script: |
                            echo "Restoring project dependencies..."
                            displayName: 'Restore dependencies'


  # Deploy stages - each has its own approval. Triggers GitHub Deploy workflow only for repos with build artifacts.
  # deploy-stage-east, deploy-stage-west, deploy-prod-east, deploy-prod-west
  - stage: stage_east_deploy
    displayName: 'Stage East Deploy'
    jobs:
      - deployment: DeployStageEast
        displayName: 'Deploy to Stage East'
        environment: 'deploy-stage-east'
        pool:
          name: 'Default'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: PowerShell@2
                  displayName: 'Trigger deploy for repos with artifacts (Prod West)'
                  env:
                    GITHUB_TOKEN: $(GITHUB_TOKEN)
                  inputs:
                    targetType: 'inline'
                    script: |
                            echo "Restoring project dependencies..."
                            displayName: 'Restore dependencies'

  - stage: stage_west_deploy
    displayName: 'Stage West Deploy'
    jobs:
      - deployment: DeployStageWest
        displayName: 'Deploy to Stage West'
        environment: 'deploy-stage-west'
        pool:
          name: 'Default'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: PowerShell@2
                  displayName: 'Trigger deploy for repos with artifacts (Stage West)'
                  env:
                    GITHUB_TOKEN: $(GITHUB_TOKEN)
                  inputs:
                    targetType: 'inline'
                    script: |
                            echo "Restoring project dependencies..."
                            displayName: 'Restore dependencies'

  - stage: prod_east_deploy
    displayName: 'Prod East Deploy'
    dependsOn:
      - stage_east_deploy
      - stage_west_deploy
    jobs:
      - deployment: DeployProdEast
        displayName: 'Deploy to Prod East'
        environment: 'deploy-prod-east'
        pool:
          name: 'Default'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: PowerShell@2
                  displayName: 'Trigger deploy for repos with artifacts (Prod East)'
                  env:
                    GITHUB_TOKEN: $(GITHUB_TOKEN)
                  inputs:
                    targetType: 'inline'
                    script: |
                            echo "Restoring project dependencies..."
                            displayName: 'Restore dependencies'

  - stage: prod_west_deploy
    displayName: 'Prod West Deploy'
    dependsOn:
      - stage_east_deploy
      - stage_west_deploy
    jobs:
      - deployment: DeployProdWest
        displayName: 'Deploy to Prod West'
        environment: 'deploy-prod-west'
        pool:
          name: 'Default'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: PowerShell@2
                  displayName: 'Trigger deploy for repos with artifacts (Prod West)'
                  env:
                    GITHUB_TOKEN: $(GITHUB_TOKEN)
                  inputs:
                    targetType: 'inline'
                    script: |
                            echo "Restoring project dependencies..."
                            displayName: 'Restore dependencies'
