# Pipeline: Create a branch in all 10 GitHub repos (repo-1 through repo-10)
# Run this pipeline and provide the branch name when prompted.

name: RollbackPipeline-$(Build.BuildId)-$(Date:yyyyMMddHHmmss)
appendCommitMessageToRunName: false

trigger: none

parameters:
  - name: PrevReleaseBranch
    displayName: 'Branch name for artifacts to be pickedup'
    type: string
  - name: Components
    displayName: 'select Components need to deployed'
    type: stringList
    default: main
    values:
      - ApplicationComponent1
      - ApplicationComponent2
      - ApplicationComponent3
      - ApplicationComponent4
      - ApplicationComponent5
      - ApplicationComponent6
      - ApplicationComponent7
      - ApplicationComponent8
      - ApplicationComponent9
      - ApplicationComponent10
  - name: githubOwner
    displayName: 'GitHub owner/username'
    type: string
    default: 'raghuramgadhamsetty'

  # Stage 1: Requires approval before generating artifact.
  # Create environment 'ci-build-approval' in DevOps (Pipelines > Environments) and add Approvals.
  - stage: GatherCIBuildInfo
    displayName: 'Gather CI build info from all repos'
    dependsOn: CreateBranch
    jobs:
      - deployment: GatherBuildInfo
        displayName: 'Latest CI run and artifact version per repo'
        environment: 'ci-build-approval'
        pool:
          name: 'Default'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: PowerShell@2
                  displayName: 'Get latest CI run and artifact version from all repos'
                  env:
                    GITHUB_TOKEN: $(GITHUB_TOKEN)
                  inputs:
                    targetType: 'inline'
                    script: |
                            echo "Restoring project dependencies..."
                            displayName: 'Restore dependencies'
                            
  # Deploy stages - each has its own approval. Triggers GitHub Deploy workflow only for repos with build artifacts.
  # deploy-stage-east, deploy-stage-west, deploy-prod-east, deploy-prod-west
  - stage: stage_east_deploy
    displayName: 'Stage East Deploy'
    dependsOn: GatherCIBuildInfo
    jobs:
      - deployment: DeployStageEast
        displayName: 'Deploy to Stage East'
        environment: 'deploy-stage-east'
        pool:
          name: 'Default'
        strategy:
          runOnce:
            deploy:
              steps:
                script: |
                        echo "Restoring project dependencies..."
                        displayName: 'Restore dependencies'

  - stage: stage_west_deploy
    displayName: 'Stage West Deploy'
    dependsOn: GatherCIBuildInfo
    jobs:
      - deployment: DeployStageWest
        displayName: 'Deploy to Stage West'
        environment: 'deploy-stage-west'
        pool:
          name: 'Default'
        strategy:
          runOnce:
            deploy:
              steps:
                script: |
                        echo "Restoring project dependencies..."
                        displayName: 'Restore dependencies'

  - stage: prod_east_deploy
    displayName: 'Prod East Deploy'
    dependsOn:
      - stage_east_deploy
      - stage_west_deploy
    jobs:
      - deployment: DeployProdEast
        displayName: 'Deploy to Prod East'
        environment: 'deploy-prod-east'
        pool:
          name: 'Default'
        strategy:
          runOnce:
            deploy:
              steps:
                script: |
                        echo "Restoring project dependencies..."
                        displayName: 'Restore dependencies'

  - stage: prod_west_deploy
    displayName: 'Prod West Deploy'
    dependsOn:
      - stage_east_deploy
      - stage_west_deploy
    jobs:
      - deployment: DeployProdWest
        displayName: 'Deploy to Prod West'
        environment: 'deploy-prod-west'
        pool:
          name: 'Default'
        strategy:
          runOnce:
            deploy:
              steps:
                script: |
                        echo "Restoring project dependencies..."
                        displayName: 'Restore dependencies'
